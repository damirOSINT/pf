<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TERMINAL ACCESS</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #00ff00; /* –ó–µ–ª–µ–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª */
            --error-color: #ff3333;
            --warn-color: #ffff00;
            --info-color: #00ffff;
            --white: #ffffff;
            --font-stack: 'Courier New', Courier, monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-stack);
            margin: 0;
            padding: 10px;
            font-size: 14px; /* –û–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            line-height: 1.4;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* –°–∫–∞—Ñ—Ñ–æ–ª–¥–∏–Ω–≥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ */
        #terminal-output {
            flex: 1;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 60px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –∏–Ω–ø—É—Ç */
        }

        /* –°—Ç—Ä–æ–∫–∞ –≤–≤–æ–¥–∞ */
        .input-line {
            display: flex;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-color);
            padding: 10px;
            box-sizing: border-box;
            border-top: 1px solid #333;
        }

        .prompt-label {
            color: var(--text-color);
            margin-right: 8px;
            font-weight: bold;
            white-space: nowrap;
        }

        #cmd-input {
            background: transparent;
            border: none;
            color: var(--white);
            font-family: var(--font-stack);
            font-size: 16px; /* –ß—Ç–æ–±—ã iOS –Ω–µ –∑—É–º–∏–ª */
            flex-grow: 1;
            outline: none;
            caret-color: var(--text-color);
        }

        /* –£—Ç–∏–ª–∏—Ç—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≤—ã–≤–æ–¥–∞ */
        .log-error { color: var(--error-color); }
        .log-warn { color: var(--warn-color); }
        .log-info { color: var(--info-color); }
        .log-white { color: var(--white); }
        .log-box {
            border: 1px solid var(--text-color);
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }

        /* –ò–ì–†–û–í–û–ô –û–í–ï–†–õ–ï–ô (Reflash) */
        #game-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #word-canvas {
            border: 2px solid var(--text-color);
            margin-bottom: 20px;
            background: #111;
            max-width: 100%;
        }

        #game-input {
            background: #222;
            border: 1px solid var(--text-color);
            color: var(--white);
            padding: 15px;
            font-size: 20px;
            text-align: center;
            width: 80%;
            font-family: var(--font-stack);
            margin-bottom: 10px;
            outline: none;
        }

        .progress-bar {
            width: 80%;
            height: 6px;
            background: #333;
            margin-top: 10px;
            border-radius: 3px;
            overflow: hidden;
        }
        
        #timer-fill {
            height: 100%;
            width: 100%;
            background: var(--text-color);
            transition: width linear;
        }

        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="terminal-output"></div>

    <div class="input-line">
        <span class="prompt-label" id="prompt-text">user@gsm-tower:~$</span>
        <input type="text" id="cmd-input" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" enterkeyhint="go">
    </div>

    <div id="game-overlay">
        <h2 style="color: var(--text-color); margin-bottom: 10px;">–ü–†–û–¢–û–ö–û–õ –ü–ï–†–ï–ü–†–û–®–ò–í–ö–ò</h2>
        <div style="color: #888; margin-bottom: 20px; font-size: 12px;">–í–í–ï–î–ò–¢–ï –°–õ–û–í–û –° –ö–ê–†–¢–ò–ù–ö–ò</div>
        
        <canvas id="word-canvas" width="250" height="80"></canvas>
        
        <input type="text" id="game-input" placeholder=">_" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        
        <div class="progress-bar">
            <div id="timer-fill"></div>
        </div>
        <div id="game-status" style="margin-top: 20px; color: var(--error-color);"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // --- –≠–õ–ï–ú–ï–ù–¢–´ DOM ---
        const outputDiv = document.getElementById('terminal-output');
        const inputField = document.getElementById('cmd-input');
        const promptText = document.getElementById('prompt-text');
        
        // --- –°–û–°–¢–û–Ø–ù–ò–ï ---
        let state = {
            mode: 'tower', // 'tower' –∏–ª–∏ 'owner'
            user: 'user',
            chip: {},      // –î–∞–Ω–Ω—ã–µ —á–∏–ø–∞ (–µ—Å–ª–∏ tower)
            vpn: {},       // –î–∞–Ω–Ω—ã–µ VPN (–µ—Å–ª–∏ owner)
            commandHistory: [],
            historyIndex: -1
        };

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–• ---
        try {
            // –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ URL Hash: #data={JSON}
            const rawHash = window.location.hash.slice(1);
            if (rawHash.startsWith('data=')) {
                const jsonStr = decodeURIComponent(rawHash.replace('data=', ''));
                const parsed = JSON.parse(jsonStr);
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å—Ç–µ–π—Ç —Å –ø—Ä–∏—à–µ–¥—à–∏–º
                state = { ...state, ...parsed };
            }
        } catch (e) {
            printLine("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö: " + e.message, "log-error");
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–º–ø—Ç–∞
        if (state.mode === 'owner') {
            promptText.innerText = `root@vpn-server:~#`;
            document.title = "VPN ROOT TERMINAL";
        } else {
            promptText.innerText = `${state.user}@gsm-tower:~$`;
            document.title = "GSM TOWER TERMINAL";
        }

        // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        const date = new Date().toLocaleString('ru-RU');
        printLine(`Linux 5.10.0-8-amd64 (tty1)`);
        printLine(`Time: ${date}`);
        printLine(`System initialized. Mode: ${state.mode.toUpperCase()}`);
        printLine(`–í–≤–µ–¥–∏—Ç–µ 'help' –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.\n`, "log-white");

        // --- –§–£–ù–ö–¶–ò–ò –í–´–í–û–î–ê ---
        function printLine(text, className = "") {
            const line = document.createElement('div');
            line.className = className;
            line.innerText = text; // innerText –±–µ–∑–æ–ø–∞—Å–µ–Ω –æ—Ç XSS
            outputDiv.appendChild(line);
            window.scrollTo(0, document.body.scrollHeight);
        }

        function printHTML(html) {
            const line = document.createElement('div');
            line.innerHTML = html;
            outputDiv.appendChild(line);
            window.scrollTo(0, document.body.scrollHeight);
        }

        // --- –û–ë–†–ê–ë–û–¢–ö–ê –í–í–û–î–ê ---
        inputField.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const cmd = this.value.trim();
                if (cmd) {
                    printLine(promptText.innerText + " " + cmd);
                    processCommand(cmd);
                    state.commandHistory.push(cmd);
                    state.historyIndex = state.commandHistory.length;
                }
                this.value = '';
                // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—Ç—å, —Å–∫—Ä–æ–ª–ª–∏–º
                setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
            }
        });

        // --- –õ–û–ì–ò–ö–ê –ö–û–ú–ê–ù–î ---
        function processCommand(rawCmd) {
            const parts = rawCmd.split(/\s+/);
            const cmd = parts[0].toLowerCase();
            const args = parts.slice(1);

            // –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã
            if (cmd === 'clear') {
                outputDiv.innerHTML = '';
                return;
            }
            
            if (cmd === 'help') {
                if (state.mode === 'owner') {
                    printBox("–ö–û–ú–ê–ù–î–´ –í–õ–ê–î–ï–õ–¨–¶–ê VPN", 
                        "status          - –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞\n" +
                        "clients         - –í—Å–µ –∞–±–æ–Ω–µ–Ω—Ç—ã\n" +
                        "online          - –ê–∫—Ç–∏–≤–Ω—ã–µ –∞–±–æ–Ω–µ–Ω—Ç—ã\n" +
                        "stats           - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n" +
                        "bills           - –°—á–µ—Ç–∞ –∑–∞ —Å–≤–µ—Ç\n" +
                        "pay electricity - –û–ø–ª–∞—Ç–∏—Ç—å —Å—á—ë—Ç\n" +
                        "logs            - –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π\n" +
                        "clear           - –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω"
                    );
                } else {
                    printBox("–î–û–°–¢–£–ü–ù–´–ï –ö–û–ú–ê–ù–î–´", 
                        "status     - –°—Ç–∞—Ç—É—Å –≤—ã—à–∫–∏\n" +
                        "chipinfo   - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∏–ø–µ\n" +
                        "cooldown   - –û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ (–ø—Ä–∏ 4/5)\n" +
                        "connect    - –ü–æ–¥–∫–ª. –∫ VPN (connect vpn://KEY)\n" +
                        "disconnect - –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è –æ—Ç VPN\n" +
                        "reflash    - –ü–µ—Ä–µ–ø—Ä–æ—à–∏–≤–∫–∞ (reflash [freq])\n" +
                        "clear      - –û—á–∏—Å—Ç–∏—Ç—å —ç–∫—Ä–∞–Ω"
                    );
                }
                return;
            }

            // --- –†–ï–ñ–ò–ú –í–õ–ê–î–ï–õ–¨–¶–ê VPN ---
            if (state.mode === 'owner') {
                handleOwnerCommands(cmd, args);
            } 
            // --- –†–ï–ñ–ò–ú –í–´–®–ö–ò ---
            else {
                handleTowerCommands(cmd, args);
            }
        }

        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö: OWNER ---
        function handleOwnerCommands(cmd, args) {
            const vpn = state.vpn || {};
            
            switch (cmd) {
                case 'status':
                    printBox("–°–¢–ê–¢–£–° –°–ï–†–í–ï–†–ê", 
                        `–ù–∞–∑–≤–∞–Ω–∏–µ: ${vpn.name || 'Unknown'}\n` +
                        `–ß–∞—Å—Ç–æ—Ç–∞: ${vpn.freq || '0.0'} MHz\n` +
                        `–°—Ç–∞—Ç—É—Å: üü¢ –†–ê–ë–û–¢–ê–ï–¢\n\n` +
                        `–°–µ—Ä–≤–µ—Ä–æ–≤: ${vpn.servers || 0}\n` +
                        `–ê–±–æ–Ω–µ–Ω—Ç–æ–≤: ${vpn.active || 0}/${vpn.total_users || 0}\n\n` +
                        `–ë–∞–ª–∞–Ω—Å: ${formatMoney(vpn.balance)} ‚≠ê`
                    );
                    break;
                case 'clients':
                    // –ó–¥–µ—Å—å –≤ –∏–¥–µ–∞–ª–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ API, –Ω–æ –º—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                    const clientsList = vpn.clients || [];
                    if (clientsList.length === 0) {
                        printLine("–°–ø–∏—Å–æ–∫ –∞–±–æ–Ω–µ–Ω—Ç–æ–≤ –ø—É—Å—Ç.", "log-info");
                    } else {
                        let out = "‚îå –°–ü–ò–°–û–ö –ê–ë–û–ù–ï–ù–¢–û–í\n";
                        clientsList.forEach(c => {
                            const icon = c.status === '–ê–∫—Ç–∏–≤–µ–Ω' ? 'üü¢' : 'üî¥';
                            out += `‚îÇ ${icon} ${c.name} [${c.status}]\n`;
                        });
                        out += "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
                        printLine(out);
                    }
                    break;
                case 'online':
                     const onlineList = (vpn.clients || []).filter(c => c.status === '–ê–∫—Ç–∏–≤–µ–Ω');
                     printLine(`–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: ${onlineList.length}`, "log-info");
                     break;
                case 'bills':
                    const bills = vpn.bills || [];
                    if (bills.length === 0) {
                        printLine("–ù–µ—Ç –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤.", "log-info");
                    } else {
                        bills.forEach(b => {
                            printBox("–°–ß–Å–¢ –ó–ê –≠–õ–ï–ö–¢–†–û–≠–ù–ï–†–ì–ò–Æ", 
                                `–ö –æ–ø–ª–∞—Ç–µ: ${formatMoney(b.amount)} ‚≠ê\n` +
                                `–°—Ä–æ–∫: ${b.time}\n` +
                                `–ö–æ–º–∞–Ω–¥–∞: pay electricity`
                            );
                        });
                    }
                    break;
                case 'pay':
                    if (args[0] === 'electricity') {
                        tg.sendData(JSON.stringify({ type: 'pay_bill' }));
                        tg.close();
                    } else {
                        printLine("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ–ø–ª–∞—Ç—ã.", "log-error");
                    }
                    break;
                case 'stats':
                case 'logs':
                    printLine("–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞...", "log-info");
                    setTimeout(() => printLine("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: –î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –≤ offline-—Ä–µ–∂–∏–º–µ.", "log-warn"), 500);
                    break;
                default:
                    printLine(`bash: ${cmd}: command not found`, "log-error");
            }
        }

        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö: TOWER ---
        function handleTowerCommands(cmd, args) {
            const chip = state.chip || {};

            switch (cmd) {
                case 'status':
                    const hp = '‚ô•'.repeat(chip.hp) + '‚ô°'.repeat(3 - chip.hp);
                    const tempFilled = '‚ñì'.repeat(chip.temp);
                    const tempEmpty = '‚ñë'.repeat(5 - chip.temp);
                    
                    let statusColor = "log-white";
                    let statusText = "–ù–æ—Ä–º–∞";
                    
                    if (chip.temp === 4) { statusText = "–¢–†–ï–ë–£–ï–¢–°–Ø –û–•–õ–ê–ñ–î–ï–ù–ò–ï"; statusColor = "log-warn"; }
                    if (chip.temp >= 5) { statusText = "–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–ï–†–ï–ì–†–ï–í"; statusColor = "log-error"; }

                    printBox("–°–û–°–¢–û–Ø–ù–ò–ï –°–ò–°–¢–ï–ú–´",
                        `–ú–æ–¥—É–ª—å: ${chip.model || '–ù–µ—Ç'}\n` +
                        `–ó–¥–æ—Ä–æ–≤—å–µ: ${hp} (${chip.hp}/3)\n` +
                        `–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${tempFilled}${tempEmpty} (${chip.temp}/5)\n` +
                        `VPN: ${chip.vpn_status || '–û—Ç–∫–ª—é—á–µ–Ω'}`
                    );
                    if (chip.temp === 4) printLine("‚ö† –í–ù–ò–ú–ê–ù–ò–ï: –≤–≤–µ–¥–∏—Ç–µ 'cooldown'", "log-warn");
                    break;

                case 'chipinfo':
                    printBox("–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ß–ò–ü–ï",
                        `–ú–æ–¥–µ–ª—å: ${chip.model}\n` +
                        `–ß–∞—Å—Ç–æ—Ç–∞: ${chip.freq || '–ù–µ—Ç'} MHz\n` +
                        `–ü—Ä–æ–≤–∞–π–¥–µ—Ä: ${chip.provider || '–ù–µ—Ç'}`
                    );
                    break;

                case 'cooldown':
                    if (chip.temp === 4) {
                        tg.sendData(JSON.stringify({ type: 'cooldown' }));
                        tg.close();
                    } else if (chip.temp >= 5) {
                        printLine("–û—à–∏–±–∫–∞: –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≥—Ä–µ—Ç–∞ –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞.", "log-error");
                    } else {
                        printLine("–û—Ö–ª–∞–∂–¥–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.", "log-info");
                    }
                    break;

                case 'connect':
                    if (!args[0]) {
                        printLine("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: connect vpn://KEY", "log-warn");
                    } else if (!args[0].startsWith('vpn://')) {
                        printLine("–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–ª—é—á–∞.", "log-error");
                    } else {
                        tg.sendData(JSON.stringify({ type: 'connect', key: args[0] }));
                        tg.close();
                    }
                    break;
                
                case 'disconnect':
                    tg.sendData(JSON.stringify({ type: 'disconnect' }));
                    tg.close();
                    break;

                case 'reflash':
                    if (!args[0]) {
                        printLine("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: reflash [—á–∞—Å—Ç–æ—Ç–∞]", "log-warn");
                    } else {
                        startReflashGame(args[0]);
                    }
                    break;

                default:
                    printLine(`bash: ${cmd}: command not found`, "log-error");
            }
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò UI ---
        function printBox(title, content) {
            let out = `‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n`;
            out +=    `‚îÇ  ${title.padEnd(36)}‚îÇ\n`;
            out +=    `‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§\n`;
            content.split('\n').forEach(line => {
                out += `‚îÇ  ${line.padEnd(36)}‚îÇ\n`;
            });
            out +=    `‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò`;
            printLine(out);
        }

        function formatMoney(amount) {
            return (amount || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // ==========================================
        // === –ú–ò–ù–ò-–ò–ì–†–ê REFLASH (–ü–ï–†–ï–ü–†–û–®–ò–í–ö–ê) ===
        // ==========================================
        
        const REFLASH_WORDS = [
            "marketplace", "algorithm", "frequency", "bandwidth", "encrypted",
            "protocol", "synchronize", "authentication", "transmission", "modulation",
            "infrastructure", "wavelength", "oscillator", "capacitor", "transistor"
        ];
        
        let game = {
            active: false,
            stage: 0,
            targetFreq: 0,
            currentWord: "",
            timer: null,
            maxTime: 4000 // 4 —Å–µ–∫—É–Ω–¥—ã
        };

        const gameOverlay = document.getElementById('game-overlay');
        const gameInput = document.getElementById('game-input');
        const timerFill = document.getElementById('timer-fill');
        const canvas = document.getElementById('word-canvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('game-status');

        function startReflashGame(freq) {
            game.targetFreq = freq;
            game.stage = 0;
            game.active = true;
            gameOverlay.style.display = 'flex';
            statusDiv.innerText = "";
            nextGameWord();
        }

        function nextGameWord() {
            if (game.stage >= 5) {
                endGame(true);
                return;
            }

            // –í—ã–±–æ—Ä —Å–ª–æ–≤–∞
            game.currentWord = REFLASH_WORDS[Math.floor(Math.random() * REFLASH_WORDS.length)];
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            drawWordToCanvas(game.currentWord);
            
            // –°–±—Ä–æ—Å –∏–Ω–ø—É—Ç–∞
            gameInput.value = '';
            gameInput.focus();
            
            // –¢–∞–π–º–µ—Ä
            startTimer();
        }

        function drawWordToCanvas(text) {
            // –û—á–∏—Å—Ç–∫–∞
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –®—É–º
            for (let i = 0; i < 50; i++) {
                ctx.fillStyle = Math.random() > 0.5 ? '#222' : '#003300';
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 2, 2);
            }

            // –¢–µ–∫—Å—Ç
            ctx.font = 'bold 28px Courier New';
            ctx.fillStyle = '#00ff00';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // –ù–µ–±–æ–ª—å—à–æ–µ –∏—Å–∫–∞–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç OCR
            ctx.save();
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate((Math.random() - 0.5) * 0.1);
            ctx.fillText(text, 0, 0);
            ctx.restore();
            
            // –õ–∏–Ω–∏–∏ –ø–æ–º–µ—Ö
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
            ctx.moveTo(0, Math.random() * canvas.height);
            ctx.lineTo(canvas.width, Math.random() * canvas.height);
            ctx.stroke();
        }

        function startTimer() {
            if (game.timer) clearTimeout(game.timer);
            
            // CSS –∞–Ω–∏–º–∞—Ü–∏—è
            timerFill.style.transition = 'none';
            timerFill.style.width = '100%';
            
            // –§–æ—Ä—Å –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
            void timerFill.offsetWidth;
            
            timerFill.style.transition = `width ${game.maxTime}ms linear`;
            timerFill.style.width = '0%';

            game.timer = setTimeout(() => {
                failGame("–í–†–ï–ú–Ø –í–´–®–õ–û");
            }, game.maxTime);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ –∏–≥—Ä–µ
        gameInput.addEventListener('input', function() {
            if (!game.active) return;
            
            const val = this.value.toLowerCase();
            const target = game.currentWord.toLowerCase();

            // –ï—Å–ª–∏ –≤–≤–µ–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –¥–ª–∏–Ω–Ω–µ–µ –∏–ª–∏ —Ä–∞–≤–Ω–æ–µ —Å–ª–æ–≤—É (–Ω–æ –Ω–µ —Ç–æ) -> –æ—à–∏–±–∫–∞
            if (val.length >= target.length && val !== target) {
                 failGame("–û–®–ò–ë–ö–ê –í–í–û–î–ê");
                 return;
            }
            
            // –ï—Å–ª–∏ –±—É–∫–≤–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –Ω–∞ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ -> —Å—Ç—Ä–æ–≥–∞—è –æ—à–∏–±–∫–∞
            if (!target.startsWith(val)) {
                failGame("–û–ü–ï–ß–ê–¢–ö–ê");
                return;
            }

            if (val === target) {
                if (game.timer) clearTimeout(game.timer);
                game.stage++;
                statusDiv.style.color = "#00ff00";
                statusDiv.innerText = `–°–õ–û–í–û ${game.stage}/5 OK`;
                setTimeout(nextGameWord, 500);
            }
        });

        // –ó–∞–ø—Ä–µ—Ç –≤—Å—Ç–∞–≤–∫–∏ (Paste)
        gameInput.addEventListener('paste', function(e) {
            e.preventDefault();
            statusDiv.innerText = "–í–°–¢–ê–í–ö–ê –ó–ê–ü–†–ï–©–ï–ù–ê!";
        });

        function failGame(reason) {
            game.active = false;
            statusDiv.style.color = "red";
            statusDiv.innerText = `üî• ${reason}`;
            if (game.timer) clearTimeout(game.timer);
            
            setTimeout(() => {
                endGame(false, reason);
            }, 1500);
        }

        function endGame(success, reason="") {
            gameOverlay.style.display = 'none';
            if (success) {
                printLine(`‚úÖ –ü–ï–†–ï–ü–†–û–®–ò–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê (FREQ: ${game.targetFreq})`, "log-info");
                tg.sendData(JSON.stringify({ type: 'reflash_success', freq: game.targetFreq }));
            } else {
                printLine(`üî• –°–ë–û–ô –ü–ï–†–ï–ü–†–û–®–ò–í–ö–ò: ${reason}`, "log-error");
                printLine(`–ß–∏–ø —É–Ω–∏—á—Ç–æ–∂–µ–Ω.`, "log-error");
                tg.sendData(JSON.stringify({ type: 'reflash_fail', reason: reason }));
            }
            tg.close();
        }

    </script>
</body>
</html>
